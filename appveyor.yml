version: 0.14-{build}-{branch}

environment:
  matrix:
  - BITS: 32
    QTDIR: C:\Qt\Qt5.4.2\5.4\msvc2013_opengl
    ARCH: x86
  - BITS: 64
    QTDIR: C:\Qt\Qt5.4.2\5.4\msvc2013_64_opengl
    ARCH: amd64

# Uncomment to enable RDP
#init:
#- ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

install:
- ps: |
    # Setup precompiled SDK

    $source = "http://trueta.udg.edu/apt/windows/devel/0.13/Starviewer-sdk-win$env:BITS-0.13-0.7z"
    $destination = "c:\Starviewer-sdk-win$env:BITS-0.13-0.7z"
    Invoke-WebRequest $source -OutFile $destination

    7z x $destination -oc:\ > 7z-output.txt

    $env:PATH = "$env:QTDIR\bin;c:\vtk\6.1.0-$env:BITS\bin;c:\gdcm\2.4.4-$env:BITS\bin;c:\ThreadWeaver\5.3.0-$env:BITS\bin;$env:PATH"


    # Setup jom

    $source = "http://ftp.fau.de/qtproject/official_releases/jom/jom_1_1_0.zip"
    $destination = "c:\jom.zip"
    Invoke-WebRequest $source -OutFile $destination

    7z x $destination -oc:\jom\

    $env:PATH = "$env:PATH;c:\jom"


    # Qt 5.4 WebEngine

    if ($env:BITS -eq 32) { $qtinstaller = "qt-opensource-windows-x86-msvc2013_opengl-5.4.2.exe" }
    else { $qtinstaller = "qt-opensource-windows-x86-msvc2013_64_opengl-5.4.2.exe" }

    $source = "http://qt.mirror.constant.com/archive/qt/5.4/5.4.2/$qtinstaller"
    $destination = "c:\$qtinstaller"
    Invoke-WebRequest $source -OutFile $destination

    $source = "https://autohotkey.com/download/ahk-u64.zip"
    $destination = "c:\ahk-u64.zip"
    Invoke-WebRequest $source -OutFile $destination

    7z x $destination -oc:\

    $ahk = @"
    Run c:\$qtinstaller
    WinWait, Qt 5.4.2 Setup, , 1
    WinActivate, Qt 5.4.2 Setup, , AppVeyor Build Agent
    Sleep 300
    Send {Enter 3}
    Send !a
    Sleep 200
    Send {Enter 2}
    Send !i
    "@
    echo $ahk > script.ahk
    c:\AutoHotKey script.ahk

    sleep 180

build_script:
- cmd: |
    call "%ProgramFiles(x86)%\Microsoft Visual Studio 12.0\VC\vcvarsall.bat" %ARCH%
    cd starviewer
    qmake
    jom -j2

test_script:
- ps: |
    cd tests\auto
    .\autotests -saveOutputToDir results -xunitxml

    cd results
    $wc = New-Object 'System.Net.WebClient'
    ls | % {
        $wc.UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path $_.Name))
        $content = cat $_
        if ($content -Match 'result="fail"') {
            echo $content "------------"
        }
    }

    if ($LASTEXITCODE -ne 0) {
        Add-AppveyorMessage "$LASTEXITCODE test(s) failed" -Category Error
        throw "$LASTEXITCODE test(s) failed"
    }
    else {
        Add-AppveyorMessage "All tests OK"
    }
